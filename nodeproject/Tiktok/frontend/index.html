<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TikTok Transcript Viewer</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <style>
    body { background: #0f172a; color:#f8fafc; }
    .navbar-brand { font-weight:600; }
    .card { border-radius: 16px; box-shadow:0 8px 24px -6px rgba(0,0,0,.4); }
    .gradient-btn { background:linear-gradient(135deg,#6366f1,#8b5cf6); border:none; }
    .gradient-btn:hover { filter:brightness(1.1); }
    pre { white-space:pre-wrap; word-break:break-word; }
    .badge-soft { background:#1e293b; color:#cbd5e1; }
    footer { font-size:.75rem; opacity:.7; }
    #tableWrapper table { font-size:.85rem; }
  </style>
</head>
<body>
  <nav class="navbar navbar-dark bg-dark mb-4">
    <div class="container-fluid">
      <span class="navbar-brand">TikTok Transcript Viewer</span>
    </div>
  </nav>

  <div class="container mb-5">
    <div class="card bg-dark text-light mb-4">
      <div class="card-body">
        <h5 class="card-title">Fetch Transcript</h5>
        <p class="text-secondary">Enter a public TikTok video URL to retrieve transcript data (server side via SupaData).</p>
        <form id="transcriptForm" class="row gy-2 gx-3 align-items-center" onsubmit="event.preventDefault(); getTranscript();">
          <div class="col-md-9">
            <input id="url" required placeholder="https://www.tiktok.com/@user/video/123456" class="form-control form-control-lg" />
          </div>
          <div class="col-md-3 d-grid">
            <button id="fetchBtn" type="submit" class="btn btn-lg gradient-btn text-white">Get Transcript</button>
          </div>
        </form>
        <div id="status" class="mt-3"></div>
      </div>
    </div>

    <ul class="nav nav-tabs" id="resultTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="json-tab" data-bs-toggle="tab" data-bs-target="#json" type="button" role="tab">JSON</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="table-tab" data-bs-toggle="tab" data-bs-target="#table" type="button" role="tab">Table</button>
      </li>
    </ul>
    <div class="tab-content pt-3" id="resultContent">
      <div class="tab-pane fade show active" id="json" role="tabpanel">
        <pre id="output" class="bg-dark p-3 rounded border border-secondary" style="min-height:160px;">Awaiting transcript...</pre>
      </div>
      <div class="tab-pane fade" id="table" role="tabpanel">
        <div id="tableWrapper" class="table-responsive"></div>
      </div>
    </div>

    <div id="meta" class="mt-4"></div>
  </div>

  <footer class="text-center text-secondary mb-4">&copy; 2025 Transcript Viewer Demo</footer>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
  <script>
    async function getTranscript() {
      const urlEl = document.getElementById('url');
      const statusEl = document.getElementById('status');
      const outputEl = document.getElementById('output');
      const tableWrapper = document.getElementById('tableWrapper');
      const fetchBtn = document.getElementById('fetchBtn');
      const metaEl = document.getElementById('meta');
      const tiktokUrl = urlEl.value.trim();
      if(!tiktokUrl) return;

      statusEl.innerHTML = '<span class="text-info">Requesting transcript...</span>';
      outputEl.textContent = 'Loading...';
      tableWrapper.innerHTML = '';
      metaEl.innerHTML = '';
      fetchBtn.disabled = true;
      fetchBtn.textContent = 'Fetching...';
      try {
        const res = await fetch('/transcript', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ url: tiktokUrl })
        });
        if(!res.ok) throw new Error('Server responded ' + res.status);
        const data = await res.json();
        // Pretty JSON
        outputEl.textContent = JSON.stringify(data, null, 2);
        statusEl.innerHTML = '<span class="text-success">Transcript loaded.</span>';

        buildTable(data, tableWrapper);
        buildMeta(data, metaEl);
      } catch(err) {
        statusEl.innerHTML = '<span class="text-danger">' + (err.message || 'Error') + '</span>';
        outputEl.textContent = 'Error: ' + err + '\nCheck console/network tab.';
      } finally {
        fetchBtn.disabled = false;
        fetchBtn.textContent = 'Get Transcript';
      }
    }

    function buildMeta(data, container){
      if(!data || typeof data !== 'object') return;
      const videoTitle = data.title || data.videoTitle || 'Unknown Title';
      const lang = data.language || data.lang || 'n/a';
      container.innerHTML = `
        <div class="card bg-dark text-light">
          <div class="card-body">
            <h6 class="card-subtitle mb-2">Metadata</h6>
            <p class="mb-1"><strong>Title:</strong> ${videoTitle}</p>
            <p class="mb-1"><strong>Language:</strong> ${lang}</p>
            <p class="mb-1"><strong>Mode:</strong> ${data.mode || 'n/a'}</p>
            <p class="mb-1"><strong>Segments:</strong> ${(data.segments && data.segments.length) || (data.items && data.items.length) || '0'}</p>
          </div>
        </div>`;
    }

    function buildTable(data, container){
      // Try common property names for transcript segments
      const segments = data.segments || data.items || data.captions || null;
      if(!segments || !Array.isArray(segments) || segments.length === 0){
        container.innerHTML = '<div class="text-secondary">No structured segments found to render as a table.</div>';
        return;
      }
      let html = '<table class="table table-dark table-striped table-hover">';
      html += '<thead><tr><th>#</th><th>Start</th><th>End</th><th>Text</th></tr></thead><tbody>';
      segments.forEach((seg, i) => {
        const start = seg.start || seg.startTime || seg.ts || '';
        const end = seg.end || seg.endTime || '';
        const text = seg.text || seg.caption || seg.content || JSON.stringify(seg);
        html += `<tr><td>${i+1}</td><td>${start}</td><td>${end}</td><td>${escapeHtml(text)}</td></tr>`;
      });
      html += '</tbody></table>';
      container.innerHTML = html;
    }

    function escapeHtml(str){
      if(typeof str !== 'string') return str;
      return str.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));
    }
  </script>
</body>
</html>
